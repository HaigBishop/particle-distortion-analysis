#:kivy 2.2.0
# App: Particle Deformation Analysis
# Author: Haig Bishop

#:set DARK_GREY (32/255, 33/255, 35/255, 1)
#:set DARKISH_GREY (42/255, 42/255, 45/255, 1)
#:set GREY (62/255, 62/255, 59/255, 1)
#:set LIGHT_GREY (98/255, 99/255, 101/255, 1)
#:set WHITE (1,1,1,1)

#:set TANGY (241/255, 148/255, 82/255, 1)
#:set DIM_TANGY (122/255, 100/255, 84/255, 1)

#:set CLEAR_GREY (0, 0, 0, 0.4)
#:set CLEAR_WHITE (1, 1, 1, 0.1)
#:set CLEAR (0, 0, 0, 0)

#:set RED (1, 0, 0, 1)


# =========================================================================================

WindowManager:
    MainWindow:
    IE1Window:
    IE3Window:
    TD1Window:








# =========================================================================================
# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# =========================================================================================

<MainWindow>:
    name: 'main'
    info_layout: info_layout
    main_grid: main_grid
    help_scroll: help_scroll
    # Main split
    GridLayout:
        id: main_grid
        rows: 2
        # Title / (i) split
        GridLayout:
            id: top_grid
            size_hint_y: None
            height: '95dp'
            cols: 3
            FloatLayout:
                id: spacer_bar
                size_hint_x: None
                width: '20dp'
            # Title / subtitle split
            GridLayout:
                rows: 2
                size_hint_y: 1
                size_hint_x: None
                width: top_grid.width - spacer_bar.width - info_btn_layout.width
                FloatLayout:
                    size_hint_y: 0.6
                    size_hint_x: 1
                    # Title
                    Label:
                        id: title_label
                        text: 'Indeukbaar?'
                        font_name: 'resources\\Inter.ttf'
                        font_size: '44dp'
                        size_hint: None, None
                        size: self.texture_size
                        valign: 'bottom'
                        halign: 'left'
                        pos_hint: {'x': 0, 'y': 0}
                    # version
                    Label:
                        text: 'v0.1'
                        font_name: 'resources\\Inter.ttf'
                        font_size: '21dp'
                        padding: [dp(7), 0]
                        size_hint: None, None
                        size: self.texture_size
                        valign: 'bottom'
                        halign: 'left'
                        pos_hint: {'y': 0.1}
                        x: title_label.x + title_label.width
                # Subtitle
                Label:
                    text: ' Haig Bishop,  hbi34@uclive.ac.nz,  University of Canterbury'
                    font_name: 'resources\\Inter.ttf'
                    font_size: '12dp'
                    size_hint_x: 1
                    size_hint_y: 0.35
                    halign: 'left'
                    valign: 'center'
                    text_size: self.size
                    pos_hint: {'x': 0, 'y': 0}
            FloatLayout:
                id: info_btn_layout
                size_hint: None, None
                size: ('100dp', '100dp')
                # Info button
                Button:
                    background_color: CLEAR
                    background_normal: ''
                    background_down: ''
                    color: WHITE
                    font_size: '20dp'
                    text: '[b]i[/b]'
                    markup: True
                    size_hint_y: None
                    size_hint_x: None
                    pos: (top_grid.x + top_grid.width - self.width - dp(13), top_grid.y + top_grid.height - self.height - dp(13))
                    size: ('36dp', '36dp')
                    on_press: root.toggle_info()
                    canvas.before:
                        Color:
                            rgba: main_grid.disabled and LIGHT_GREY or WHITE
                        Line:
                            width: dp(1)
                            circle:
                                (self.center_x, self.center_y, self.width/2, 0, 360)
        # Options / image split
        GridLayout:
            size_hint_y: 1
            cols: 3
            FloatLayout:
                size_hint_x: None
                width: '20dp'
            # Options x 4
            GridLayout:
                rows: 4
                size_hint_x: 0.7
                # Button wrapper
                FloatLayout:
                    size_hint_y: 0.25
                    TangyButton:
                        id: btn_IE
                        font_name: 'resources\\Inter.ttf'
                        text: 'Import Experiments' # 'Images → Deformation'
                        font_size:'30dp'
                        size_hint: (1, 0.9)
                        pos_hint: {'right': 1, 'top':1}
                        on_release: 
                            app.root.current = 'IE1'
                            root.manager.transition.direction = 'left'
                FloatLayout:
                    size_hint_y: 0.25
                    TangyButton:
                        id: btn_ps
                        font_name: 'resources\\Inter.ttf'
                        font_size:'30dp'
                        text: 'Track Particle Deformation' # '...'
                        size_hint: (1, 0.9)
                        pos_hint: {'right': 1, 'top':1}
                        on_release: 
                            app.root.current = 'TD1'
                            root.manager.transition.direction = 'left'
                FloatLayout:
                    size_hint_y: 0.25
                    TangyButton:
                        id: btn_pf
                        font_name: 'resources\\Inter.ttf'
                        text: 'Fit Deformation/Current Models' # 'Deformation → Force'
                        font_size:'30dp'
                        size_hint: (1, 0.9)
                        pos_hint: {'right': 1, 'top':1}
                FloatLayout:
                    size_hint_y: 0.25
                    TangyButton:
                        id: btn_fg
                        font_name: 'resources\\Inter.ttf'
                        font_size:'30dp'
                        text: 'Predict Physical Properties' # 'Force → Plots'
                        size_hint: (1, 0.9)
                        pos_hint: {'right': 1, 'top':1}
            # Image container
            FloatLayout:
                size_hint_x: 0.3
                Image:
                    size_hint: (0.9, 0.975)
                    pos_hint: {'center_x':0.5, 'top':1}
                    fit_mode: 'cover'
                    source: 'resources\\example_image.png'
    # Whole screen float for the info screen
    FloatLayout:
        id: info_layout
        disabled: True
        opacity: 0 if self.disabled else 1
        pos: (69420, 0)
        Button:
            background_color: CLEAR
            pos_hint: {'center_x':0.5, 'center_y':0.5}
            size_hint: 1, 1
            on_press: root.toggle_info()
        FloatLayout:
            id: info_sublayout
            pos_hint: {'center_x':0.5, 'center_y':0.5}
            size_hint: 0.9, 0.9
            canvas.before:
                Color:
                    rgba: DARK_GREY
                Rectangle:
                    pos: self.pos
                    size: self.size
                Color:
                    rgba: WHITE
                Line:
                    width: 1.
                    rectangle: (self.x, self.y, self.width, self.height)
            ScrollView:
                id: help_scroll
                pos: (info_sublayout.x + dp(12), info_sublayout.y)
                size_hint: None, None
                size: (info_sublayout.width - dp(12), info_sublayout.height - dp(8))
                bar_pos_y: 'right'
                do_scroll_x: False
                do_scroll_y: True
                GridLayout:
                    id: grid
                    size_hint: None, None
                    width: help_scroll.width
                    height: max(self.minimum_height, help_scroll.height)
                    cols: 1
                    spacing: dp(3.5)
                    Label:
                        size_hint: None, None
                        size: self.texture_size
                        text: root.info_text
                        color: WHITE
                        padding: [dp(17), dp(17)]
                        markup: True
                        font_name: 'resources\\Inter.ttf'
                        font_size: '16dp'






# =========================================================================================
# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# =========================================================================================

<IE1Window>:
    name: 'IE1'
    id: ie1_window
    exp_scroll: exp_scroll
    select_vid_btn: select_vid_btn
    location_label: location_label
    ion_location_label: ion_location_label
    param_grid_layout: param_grid_layout
    name_grid_layout: name_grid_layout
    name_input: name_input
    image_widget: image_widget
    GridLayout:
        canvas:
            Color:
                rgba: CLEAR_WHITE
            Line:
                points: [0, self.height - dp(40), self.width, self.height - dp(40)]
                width: dp(0.3)
            Line:
                points: [self.width*0.75, self.height, self.width*0.75, 0]
                width: dp(0.3)
            Color:
                rgba: DARKISH_GREY
            Rectangle:
                pos: (0,0)
                size: (self.width*0.75, (self.height-dp(53)) * 0.79)
            Color:
                rgba: GREY
            Line:
                points: [self.width*0.36, (self.height-dp(53)) * 0.79, self.width*0.36, 0]
                width: dp(0.3)
        cols: 3
        GridLayout:
            rows: 2
            size_hint_x: 0.74
            GridLayout:
                cols: 3
                size_hint_y: None
                height: '40dp'
                BlankButton:
                    text:'←'
                    font_name: 'resources\\Inter.ttf'
                    font_size: '35dp'
                    padding: [0, '13dp']
                    size_hint_x: None
                    width: '80dp'
                    on_release: 
                        root.on_back_btn()
                Label:
                    font_name: 'resources\\Inter.ttf'
                    text: 'Import Experiments'
                    font_size: '22dp'
                    padding: ['3dp', '2dp']
                    size_hint_x: None
                    width: '460dp'
                    halign: 'left'
                    valign: 'center'
                    text_size: self.size
                FloatLayout:
                    size_hint_x: 1
            GridLayout:
                rows: 2
                size_hint_y: 1
                FloatLayout:
                    size_hint_y: 0.2
                    TangyButton:
                        id: select_vid_btn
                        size_hint:(None,None)
                        font_name: 'resources\\Inter.ttf'
                        size: ('105dp','33dp')
                        font_size: '11dp'
                        pos_hint: {'x':.095, 'y':.3}
                        text:'select video(s)'
                        on_release: root.schedule_with_load(root.select_vid_files)
                    Label:
                        id: location_label
                        color: WHITE
                        size_hint:(None,None)
                        size: (self.parent.width * 0.8, '27dp')
                        pos_hint: {'x':.1, 'y':0.06}
                        text: 'No file(s) selected'
                        halign: 'left'
                        font_name: 'resources\\Inter.ttf'
                        text_size: self.size
                        shorten: True
                        font_size: '10dp'
                    GridLayout:
                        id: name_grid_layout
                        disabled: app.current_experiment is None
                        cols: 2
                        size_hint:(.69, 1)
                        pos_hint: {'x':.30, 'y':0}
                        Label:
                            text: 'Experiment Name:'
                            color: WHITE
                            font_name: 'resources\\Inter.ttf'
                            font_size: '14dp'
                            size_hint_x: 0.35
                        FloatLayout:
                            size_hint_x: 0.6
                            TextInput:
                                id: name_input
                                on_text: root.on_name_text(self.text)
                                size_hint_x: 1
                                size_hint_y: None
                                pos_hint: {'x':0, 'center_y':.5}
                                height: '27dp'
                                multiline: False
                                text_align: 'justify'
                GridLayout:
                    id: param_grid_layout
                    disabled: app.current_experiment is None
                    cols: 2
                    size_hint_y: 0.8
                    FloatLayout:
                        id: ion_select_layout
                        size_hint_x: 0.5
                        rows: 2
                        TangyButton:
                            id: ion_select_btn
                            size_hint:(None,None)
                            size: ('130dp', '33dp')
                            disabled_color: DARK_GREY
                            font_size: '11dp'
                            pos_hint: {'x':.06, 'y':.83}
                            text:'select ion current file'
                            on_release: root.schedule_with_load(root.select_ion_file)
                            font_name: 'resources\\Inter.ttf'
                        Button:
                            text: '×'
                            font_size: '21dp'
                            background_color: CLEAR
                            background_normal: ''
                            color: WHITE
                            disabled: True if ion_location_label.text == 'No file selected' else False
                            size_hint: (None, None)
                            size: ('20dp', '20dp')
                            pos_hint: {'x':.052, 'y':.762}
                            on_press: root.on_ion_x_btn()
                        Label:
                            id: ion_location_label
                            color: WHITE
                            size_hint:(None,None)
                            size: (ion_select_layout.width * 0.82, '33dp')
                            pos_hint: {'x':.13, 'y':0.77}
                            text: 'No file selected'
                            halign: 'left'
                            font_name: 'resources\\Inter.ttf'
                            text_size: self.size
                            shorten: True
                            font_size: '10dp'
                    GridLayout:
                        size_hint_x: 0.5
                        rows: 2
                        Label:
                            font_name: 'resources\\Inter.ttf'
                            text: 'Video Preview'
                            font_size: '21dp'
                            size_hint: (1, 0.2)
                        Image:
                            id: image_widget
                            size_hint: (1, 0.8)
                            fit_mode: 'contain'
                            color: CLEAR if self.texture is None else WHITE
        FloatLayout:
            size_hint_x: 0.02
        GridLayout:
            id: right_grid
            rows: 6
            size_hint_x: 0.24
            Label:
                text:'Experiments (' + str(len(root.exp_scroll.grid_layout.children)) + ')' 
                size_hint_y: None
                padding: [0, '30dp']
                font_name: 'resources\\Inter.ttf'
                color: WHITE
                font_size: '17dp'
                height: '40dp'
                valign: 'center'
            ExperimentList:
                id: exp_scroll
                window: ie1_window
                size_hint:(None,None)
                height: right_grid.height - dp(120)
                width: right_grid.width - dp(4)
                bar_pos_y: 'right'
                do_scroll_x: False
                do_scroll_y: True
            FloatLayout:
                size_hint:(None,None)
                size: (right_grid.width - dp(4), dp(4))
            TangyButton:
                disabled:  len(root.exp_scroll.grid_layout.children) == 0 or not root.ion_file_attached
                disabled_color: DARK_GREY
                text: 'Proceed With Current Data'
                size_hint:(None,None)
                font_size: '12dp'
                font_name: 'resources\\Inter.ttf'
                size: (right_grid.width - dp(4), '33dp')
                on_release: root.on_proceed(with_ion=True)
            FloatLayout:
                size_hint:(None,None)
                size: (right_grid.width - dp(4), '4dp')
            TangyButton:
                disabled:  len(root.exp_scroll.grid_layout.children) == 0
                disabled_color: DARK_GREY
                text: 'Proceed Without Current Data'
                size_hint:(None,None)
                font_size: '12dp'
                font_name: 'resources\\Inter.ttf'
                size: (right_grid.width - dp(4), '33dp')
                on_release: root.on_proceed(with_ion=False)
    LoadingScreen:
        disabled: not root.is_loading
        x: 0 if root.is_loading else 69420







# =========================================================================================
# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# =========================================================================================





<IE3Window>:
    name: 'IE3'
    id: ie3_window
    exp_scroll: exp_scroll
    location_label: location_label
    ion_location_label: ion_location_label
    ion_adjust_btn: ion_adjust_btn
    video_widget: video_widget
    video_slider: video_slider
    frame_label: frame_label
    frame_text_box: frame_text_box
    ion_range_start_text_box: ion_range_start_text_box
    ion_range_end_text_box: ion_range_end_text_box
    ion_view: ion_view
    thumbnail_bar: thumbnail_bar
    export_checkbox: export_checkbox
    overwrite_checkbox: overwrite_checkbox
    GridLayout:
        canvas:
            Color:
                rgba: CLEAR_WHITE
            Line:
                points: [0, self.height - dp(40), self.width, self.height - dp(40)]
                width: dp(0.3)
            Line:
                points: [self.width*0.75, self.height, self.width*0.75, 0]
                width: dp(0.3)
            Color:
                rgba: DARKISH_GREY
            Rectangle:
                pos: (0,0)
                size: (self.width*0.75, self.height-dp(40))
        cols: 3
        GridLayout:
            rows: 2
            size_hint_x: 0.74
            GridLayout:
                cols: 3
                size_hint_y: None
                height: '40dp'
                BlankButton:
                    text:'←'
                    font_name: 'resources\\Inter.ttf'
                    font_size: '35dp'
                    padding: [0, '13dp']
                    size_hint_x: None
                    width: '80dp'
                    on_release: 
                        root.on_back_btn()
                Label:
                    font_name: 'resources\\Inter.ttf'
                    text: 'Select Events'
                    font_size: '22dp'
                    padding: ['3dp', '2dp']
                    size_hint_x: None
                    width: '460dp'
                    halign: 'left'
                    valign: 'center'
                    text_size: self.size
                FloatLayout:
                    size_hint_x: 1
            GridLayout:
                disabled: root.app.current_experiment is None
                rows: 4
                size_hint_y: 1
                # Buttons row
                GridLayout:
                    id: button_layout
                    cols: 7
                    size_hint_y: 0.1
                    ToggleBlankButton:
                        id: ion_adjust_btn
                        disabled: not (root.use_ion and root.app.current_has_ion)
                        text:'⇔'
                        font_name: 'resources\\Inter.ttf'
                        font_size: '15dp'
                        padding: [0, '13dp']
                        size_hint_x: None
                        width: self.height
                    Label:
                        id: ion_location_label
                        color: WHITE
                        size_hint_x: None
                        width: button_layout.width - button_layout.height * 6
                        text: 'No file(s) selected'
                        padding: ['13dp', 0, 0, '7dp']
                        halign: 'left'
                        font_name: 'resources\\Inter.ttf'
                        text_size: self.size
                        shorten: True
                        font_size: '11dp'
                    BlankButton:
                        text:'←'
                        font_name: 'resources\\Inter.ttf'
                        font_size: '15dp'
                        padding: [0, '13dp']
                        size_hint_x: None
                        width: self.height
                        on_press: root.scroll_left() if ion_adjust_btn.state != 'down' else root.ion_adjust_left()
                    BlankButton:
                        text:'+'
                        font_name: 'resources\\Inter.ttf'
                        font_size: '18dp'
                        padding: [0, '13dp']
                        size_hint_x: None
                        width: self.height
                        on_press: root.zoom_in() if ion_adjust_btn.state != 'down' else root.ion_adjust_in()
                    BlankButton:
                        text:'◦'
                        font_name: 'resources\\Inter.ttf'
                        font_size: '20dp'
                        padding: [0, '13dp']
                        size_hint_x: None
                        width: self.height
                        on_press: root.reset_zoom() if ion_adjust_btn.state != 'down' else root.ion_adjust_reset()
                    BlankButton:
                        text:'−'
                        font_name: 'resources\\Inter.ttf'
                        font_size: '18dp'
                        padding: [0, '13dp']
                        size_hint_x: None
                        width: self.height
                        on_press: root.zoom_out() if ion_adjust_btn.state != 'down' else root.ion_adjust_out()
                    BlankButton:
                        text:'→'
                        font_name: 'resources\\Inter.ttf'
                        font_size: '15dp'
                        padding: [0, '13dp']
                        size_hint_x: None
                        width: self.height
                        on_press: root.scroll_right() if ion_adjust_btn.state != 'down' else root.ion_adjust_right()
                GridLayout:
                    id: image_row
                    size_hint_y: 0.2
                    cols: 3
                    FloatLayout:
                        size_hint: None, 1
                        width: '52dp'
                    # Ion current view
                    IonCurrentView:
                        id: ion_view
                        ie3_window: ie3_window
                        video_slider: video_slider
                        size_hint: None, 1
                        width: max(image_row.width - dp(70), 5)
                    FloatLayout:
                        size_hint: None, 1
                        width: '18dp'
                GridLayout:
                    size_hint_y: 0.1
                    cols: 2
                    FloatLayout:
                        size_hint: None, 1
                        width: '36dp'
                    # Slider
                    Slider:
                        id: video_slider
                        min: 0
                        max: 1
                        size_hint: None, 1
                        width: ion_view.width + dp(32)
                        cursor_image: 'resources\\white_circle.png'
                        cursor_disabled_image: 'resources\\white_circle.png'
                        cursor_size: '24dp', '24dp'
                        on_value: root.on_slider()
                # Side buttons and video view
                GridLayout:
                    cols: 4
                    size_hint_y: 0.6
                    FloatLayout:
                        size_hint:(None,1)
                        width: '8dp'
                    # Side Buttons
                    GridLayout:
                        size_hint_x: 0.3
                        rows: 6
                        TangyButton:
                            disabled: not root.ready_for_start
                            disabled_color: DARK_GREY
                            text: 'Enter Start (S)'
                            size_hint:(None,None)
                            font_size: '11dp'
                            font_name: 'resources\\Inter.ttf'
                            size_hint: 1, 0.25
                            on_press: root.add_start_here()
                        FloatLayout:
                            size_hint:(1,None)
                            height: '4dp'
                        TangyButton:
                            disabled: root.ready_for_start
                            disabled_color: DARK_GREY
                            text: 'Enter Stop (S)'
                            size_hint:(None,None)
                            font_size: '11dp'
                            font_name: 'resources\\Inter.ttf'
                            size_hint: 1, 0.25
                            on_press: root.add_stop_here()
                        FloatLayout:
                            size_hint:(1,None)
                            height: '4dp'
                        TangyButton:
                            disabled: not root.slider_on_event
                            disabled_color: DARK_GREY
                            text: 'Remove (R)'
                            size_hint:(None,None)
                            font_size: '11dp'
                            font_name: 'resources\\Inter.ttf'
                            size_hint: 1, 0.25
                            on_press: root.remove_here()
                        FloatLayout:
                            size_hint:(1,1)
                            # Frame counter row
                            GridLayout:
                                cols: 3
                                size_hint: (1, None)
                                height: '27dp'
                                x: 0
                                y: '27dp' if root.use_ion and root.app.current_has_ion else 0
                                Label:
                                    text: 'Frame:'
                                    color: WHITE
                                    size_hint: (None, 1)
                                    width: '50dp'
                                    padding: ['7dp', 0, 0, 0]
                                    halign: 'left'
                                    valign: 'center'
                                    font_name: 'resources\\Inter.ttf'
                                    text_size: self.size
                                    shorten: True
                                    font_size: '12dp'
                                TextInput
                                    id: frame_text_box
                                    size_hint: (None, 0.8)
                                    width: '50dp'
                                    multiline: False
                                    text_align: 'justify'
                                    font_size: '12dp'
                                    on_text: root.on_frame_text(self.text)
                                    on_text_validate: root.on_frame_text(self.text)
                                    on_focus: root.is_typing = self.focus
                                Label:
                                    id: frame_label
                                    color: WHITE
                                    size_hint: (None, 1)
                                    width: '75dp'
                                    padding: ['7dp', 0, 0, 0]
                                    halign: 'left'
                                    valign: 'center'
                                    font_name: 'resources\\Inter.ttf'
                                    text_size: self.size
                                    shorten: True
                                    font_size: '12dp'
                            # Ion range row
                            GridLayout:
                                cols: 4
                                size_hint: (1, None)
                                height: '27dp'
                                x: 0 if root.use_ion and root.app.current_has_ion else 69420
                                y: 0
                                Label:
                                    text: 'Ion range:'
                                    color: WHITE
                                    size_hint: (None, 1)
                                    width: '70dp'
                                    padding: ['7dp', 0, 0, 0]
                                    halign: 'left'
                                    valign: 'center'
                                    font_name: 'resources\\Inter.ttf'
                                    text_size: self.size
                                    shorten: True
                                    font_size: '12dp'
                                TextInput
                                    id: ion_range_start_text_box
                                    size_hint: (None, 0.8)
                                    width: '33dp'
                                    multiline: False
                                    text_align: 'justify'
                                    font_size: '12dp'
                                    on_text: root.on_ion_range_text(self.text, 'start')
                                    on_text_validate: root.on_ion_range_text(self.text, 'start')
                                    on_focus: root.is_typing = self.focus
                                Label:
                                    text: '/'
                                    color: WHITE
                                    size_hint: (None, 1)
                                    width: '17dp'
                                    padding: [0, 0, 0, 0]
                                    halign: 'center'
                                    valign: 'center'
                                    font_name: 'resources\\Inter.ttf'
                                    text_size: self.size
                                    shorten: True
                                    font_size: '12dp'
                                TextInput
                                    id: ion_range_end_text_box
                                    size_hint: (None, 0.8)
                                    width: '50dp'
                                    multiline: False
                                    text_align: 'justify'
                                    font_size: '12dp'
                                    on_text: root.on_ion_range_text(self.text, 'end')
                                    on_text_validate: root.on_ion_range_text(self.text, 'end')
                                    on_focus: root.is_typing = self.focus
                    FloatLayout:
                        size_hint:(None,1)
                        width: '8dp'
                    # Video View & File Location Label
                    GridLayout:
                        size_hint_x: 0.7
                        rows: 4
                        Image:
                            id: video_widget
                            size_hint: (1, 0.82)
                            fit_mode: 'contain'
                            color: CLEAR if self.texture is None else WHITE
                        FloatLayout:
                            size_hint:(1, 0.01)
                        ThumbnailBar:
                            id: thumbnail_bar
                            ie3_window: root
                            video_slider: video_slider
                            size_hint: (1, 0.1)
                            canvas.after:
                                Color:
                                    rgba: RED
                                Line:
                                    points: [self.x + self.cursor_x, self.y, self.x + self.cursor_x, self.y + self.height + 1]
                                    width: 1
                                Color:
                                    rgba: CLEAR_GREY
                                # Zoom grey out (left)
                                Rectangle:
                                    pos: self.pos
                                    size: (self.width * root.zoom_start, self.height)
                                # Zoom grey out (right)
                                Rectangle:
                                    pos: (self.x + self.width * root.zoom_end, self.y)
                                    size: (self.width * (1 - root.zoom_end), self.height)
                        Label:
                            id: location_label
                            color: WHITE
                            size_hint: (1, 0.07)
                            text: 'No file(s) selected'
                            padding: ['13dp', 0, 0, '3dp']
                            halign: 'left'
                            font_name: 'resources\\Inter.ttf'
                            text_size: self.size
                            shorten: True
                            font_size: '11dp'
        FloatLayout:
            size_hint_x: 0.02
        GridLayout:
            id: right_grid
            rows: 8
            size_hint_x: 0.24
            Label:
                text:'Experiments (' + str(len(root.exp_scroll.grid_layout.children)) + ')' 
                size_hint_y: None
                padding: [0, '30dp']
                font_name: 'resources\\Inter.ttf'
                color: WHITE
                font_size: '19dp'
                height: '40dp'
                valign: 'center'
            ExperimentList:
                id: exp_scroll
                window: ie3_window
                size_hint:(None,None)
                height: right_grid.height - dp(144)
                width: right_grid.width - dp(4)
                bar_pos_y: 'right'
                do_scroll_x: False
                do_scroll_y: True
            FloatLayout:
                size_hint:(None,None)
                size: (right_grid.width - dp(4), dp(4))
            GridLayout:
                cols: 2
                size_hint:(None,None)
                size: (right_grid.width - dp(4), '27dp')
                FloatLayout:
                    id: dumbass_layout_number_1
                    size_hint: None, None
                    size: '27dp', '27dp'
                    CheckBox:
                        id: export_checkbox
                        active: True
                        size_hint: 1, 1
                        pos: dumbass_layout_number_1.x - 18 + dp(12), dumbass_layout_number_1.y - 18 + dp(12)
                        on_active: overwrite_checkbox.active = False if not self.active else overwrite_checkbox.active
                Label:
                    text: 'Export as JSON'
                    size_hint:(1,1)
                    padding: ['7dp', 0, 0, 0]
                    font_name: 'resources\\Inter.ttf'
                    color: WHITE
                    font_size: '11dp'
                    valign: 'center'
                    halign: 'left'
                    text_size: self.size
            FloatLayout:
                size_hint:(None,None)
                size: (right_grid.width - dp(4), dp(4))
            GridLayout:
                disabled: not export_checkbox.active
                cols: 2
                size_hint:(None,None)
                size: (right_grid.width - dp(4), '27dp')
                FloatLayout:
                    id: dumbass_layout_number_2
                    size_hint: None, None
                    size: '27dp', '27dp'
                    CheckBox:
                        id: overwrite_checkbox
                        active: True
                        size_hint: 1, 1
                        pos: dumbass_layout_number_2.x - 18 + dp(12), dumbass_layout_number_2.y - 18 + dp(12)
                Label:
                    text: 'Overwrite Pre-existing Files'
                    size_hint:(1,1)
                    padding: ['7dp', 0, 0, 0]
                    font_name: 'resources\\Inter.ttf'
                    color: WHITE
                    font_size: '11dp'
                    valign: 'center'
                    halign: 'left'
                    text_size: self.size
            FloatLayout:
                size_hint:(None,None)
                size: (right_grid.width - dp(4), dp(4))
            TangyButton:
                disabled:  len(root.exp_scroll.grid_layout.children) == 0
                disabled_color: DARK_GREY
                text: 'Proceed'
                size_hint:(None,None)
                font_size: '11dp'
                font_name: 'resources\\Inter.ttf'
                size: (right_grid.width - dp(4), '33dp')
                on_release: root.on_proceed()






# =========================================================================================
# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# =========================================================================================

<TD1Window>:
    name: 'TD1'
    id: td1_window
    evt_scroll: evt_scroll
    select_event_btn: select_event_btn
    location_label: location_label
    param_grid_layout: param_grid_layout
    name_grid_layout: name_grid_layout
    name_input: name_input
    image_widget: image_widget
    GridLayout:
        canvas:
            Color:
                rgba: CLEAR_WHITE
            Line:
                points: [0, self.height - dp(40), self.width, self.height - dp(40)]
                width: 0.5
            Line:
                points: [self.width*0.75, self.height, self.width*0.75, 0]
                width: 0.5
            Color:
                rgba: DARKISH_GREY
            Rectangle:
                pos: (0,0)
                size: (self.width*0.75, (self.height-dp(53)) * 0.79)
        cols: 3
        GridLayout:
            rows: 2
            size_hint_x: 0.74
            GridLayout:
                cols: 3
                size_hint_y: None
                height: '40dp'
                BlankButton:
                    text:'←'
                    font_name: 'resources\\Inter.ttf'
                    font_size: '35dp'
                    padding: [0, '13dp']
                    size_hint_x: None
                    width: '80dp'
                    on_release: 
                        root.on_back_btn()
                Label:
                    font_name: 'resources\\Inter.ttf'
                    text: 'Track Deformation'
                    font_size: '20dp'
                    padding: ['3dp', '2dp']
                    size_hint_x: None
                    width: '460dp'
                    halign: 'left'
                    valign: 'center'
                    text_size: self.size
                FloatLayout:
                    size_hint_x: 1
            GridLayout:
                rows: 2
                size_hint_y: 1
                FloatLayout:
                    size_hint_y: 0.2
                    TangyButton:
                        id: select_event_btn
                        size_hint:(None,None)
                        font_name: 'resources\\Inter.ttf'
                        size: ('110dp','33dp')
                        font_size: '12dp'
                        pos_hint: {'x':.095, 'y':.3}
                        text:'select event(s)'
                        on_release: root.select_experiment_jsons()
                    Label:
                        id: location_label
                        color: WHITE
                        size_hint:(None,None)
                        size: (self.parent.width * 0.8, '27dp')
                        pos_hint: {'x':.1, 'y':0.06}
                        text: 'No file(s) selected'
                        halign: 'left'
                        font_name: 'resources\\Inter.ttf'
                        text_size: self.size
                        shorten: True
                        font_size: '12dp'
                    GridLayout:
                        id: name_grid_layout
                        disabled: app.current_event is None
                        cols: 2
                        size_hint:(.69, 1)
                        pos_hint: {'x':.30, 'y':0}
                        Label:
                            text: 'Event Name:'
                            color: WHITE
                            font_name: 'resources\\Inter.ttf'
                            font_size: '15dp'
                            size_hint_x: 0.35
                        FloatLayout:
                            size_hint_x: 0.6
                            TextInput:
                                id: name_input
                                on_text: root.on_name_text(self.text)
                                size_hint_x: 1
                                size_hint_y: None
                                pos_hint: {'x':0, 'center_y':.5}
                                height: '27dp'
                                multiline: False
                                text_align: 'justify'
                GridLayout:
                    id: param_grid_layout
                    disabled: app.current_event is None
                    cols: 1
                    size_hint_y: 0.8
                    GridLayout:
                        size_hint_x: 1
                        rows: 2
                        Label:
                            font_name: 'resources\\Inter.ttf'
                            text: 'Video Preview'
                            font_size: '21dp'
                            size_hint: (1, 0.2)
                        Image:
                            id: image_widget
                            size_hint: (1, 0.8)
                            fit_mode: 'contain'
                            color: CLEAR if self.texture is None else WHITE
        FloatLayout:
            size_hint_x: 0.02
        GridLayout:
            id: right_grid
            rows: 4
            size_hint_x: 0.24
            Label:
                text:'Events (' + str(len(root.evt_scroll.grid_layout.children)) + ')' 
                size_hint_y: None
                padding: [0, '30dp']
                font_name: 'resources\\Inter.ttf'
                color: WHITE
                font_size: '19dp'
                height: '40dp'
                valign: 'center'
            EventList:
                id: evt_scroll
                window: td1_window
                size_hint:(None,None)
                height: right_grid.height - dp(83)
                width: right_grid.width-dp(4)
                bar_pos_y: 'right'
                do_scroll_x: False
                do_scroll_y: True
            FloatLayout:
                size_hint:(None,None)
                size: (right_grid.width-dp(4), '4dp')
            TangyButton:
                disabled:  len(root.evt_scroll.grid_layout.children) == 0
                disabled_color: DARK_GREY
                text: 'Predict Start Point'
                size_hint:(None,None)
                font_size: '13dp'
                font_name: 'resources\\Inter.ttf'
                size: (right_grid.width-dp(4), '33dp')
                on_release: root.on_predict()










# =========================================================================================





<BackPopup>:
    size_hint: 0.6, 0.4
    title: 'Return to Main Menu and lose all progress' if self.to_screen == 'main' else 'Return to previous screen and lose progress here'
    BoxLayout:
        orientation: 'vertical'
        Label:
            text: 'Are you sure?'
        BoxLayout:
            size_hint_y: None
            height: dp(40)
            Button:
                text: 'Yes'
                on_release: root.on_answer('yes')
            Button:
                text: 'No'
                on_release: root.on_answer('no')




# =========================================================================================

<ErrorPopup>:
    error_label: error_label
    size_hint: 0.6, 0.4
    auto_dismiss: False
    title: 'Invalid Data'
    BoxLayout:
        orientation: 'vertical'
        Label:
            id: error_label
        BoxLayout:
            size_hint_y: None
            height: dp(40)
            Button:
                text: 'Okay'
                on_release: root.on_answer('ok')



# =========================================================================================

<TangyButton@Button>:
    background_normal: ''
    background_color: CLEAR
    background_down: ''
    border: CLEAR
    color: DARK_GREY
    canvas.before:
        Color:
            rgba: (self.state == 'normal' and self.disabled == False) and TANGY or DIM_TANGY
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(7),]


# =========================================================================================

<BlankButton@Button>:
    background_normal: ''
    background_color: CLEAR
    background_down: ''
    border: CLEAR
    color: TANGY
    canvas.before:
        Color:
            rgba: (self.state == 'normal') and CLEAR or DIM_TANGY
        RoundedRectangle:
            pos: self.x + dp(1.5), self.y + dp(1.5)
            size: self.width-dp(3), self.height-dp(3)
            radius: [dp(10),]





# =========================================================================================

<ToggleBlankButton@ToggleButton>:
    background_normal: ''
    background_color: CLEAR
    background_down: ''
    border: CLEAR
    color: TANGY
    canvas.before:
        Color:
            rgba: (self.state == 'normal') and CLEAR or DIM_TANGY
        RoundedRectangle:
            pos: self.x + dp(1.5), self.y + dp(1.5)
            size: self.width-dp(3), self.height-dp(3)
            radius: [dp(10),]





# =========================================================================================

<ExperimentList>:
    size_hint: (1, 1)
    grid_layout: grid
    GridLayout:
        id: grid
        size_hint_y: None
        height: max(self.minimum_height,root.height)
        cols: 1
        spacing: dp(3)

        
# =========================================================================================

<ExperimentBox>:
    size_hint_x: 1
    size_hint_y: None
    height: '66dp'
    name: 'temp'
    date: None
    file_location: None
    background_normal: ''
    background_normal: ''
    background_color: CLEAR
    background_down: ''
    border: CLEAR
    canvas.before:
        Color:
            rgba: self.is_selected and TANGY or DIM_TANGY
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(8),]
    Label:
        text: 'Name:  ' + str(root.experiment.name)
        font_name: 'resources\\Inter.ttf'
        font_size: '14dp'
        color: WHITE
        size_hint: (None, None)
        size: (root.width - dp(35), '20dp')
        pos: (root.x + dp(3), root.y + dp(48))
        halign: 'left'
        color: DARK_GREY
        text_size: self.size
        shorten: True
    Label:
        text: 'File:  ' + str(root.experiment.vid_loc).split('\\')[-1].split('/')[-1]
        font_name: 'resources\\Inter.ttf'
        font_size: '14dp'
        color: WHITE
        size_hint: (None, None)
        size: (root.width, '24dp')
        pos: (root.x + dp(3), root.y + dp(27))
        halign: 'left'
        color: DARK_GREY
        text_size: self.size
        shorten: True
    Label:
        text: 'Date:  ' + str(root.experiment.vid_date)
        font_name: 'resources\\Inter.ttf'
        font_size: '14dp'
        color: WHITE
        size_hint: (None, None)
        size: (root.width, '20dp')
        pos: (root.x + dp(3), root.y + dp(7))
        halign: 'left'
        color: DARK_GREY
        text_size: self.size
        shorten: True
    Button:
        text: '×'
        font_name: 'resources\\Inter.ttf'
        font_size: '18dp'
        background_color: CLEAR
        background_normal: ''
        color: DARK_GREY
        size_hint: (None, None)
        size: ('20dp', '20dp')
        pos: (root.x + root.width - dp(20), root.y + root.height - dp(18))
        on_press: root.parent.parent.on_x_btn(root, root.window.name)
    Button:
        background_color: CLEAR
        size_hint: (None, None)
        size: ('13dp', '20dp')
        pos: (root.x + root.width - dp(32), root.y + root.height - dp(19))
        on_press: root.on_open_btn()
        Image:
            source: 'resources\\open_btn.png'
            y: self.parent.y + dp(3)
            x: self.parent.x
            size: ('13dp', '13dp')



# =========================================================================================

<EventList>:
    size_hint: (1, 1)
    grid_layout: grid
    GridLayout:
        id: grid
        size_hint_y: None
        height: max(self.minimum_height,root.height)
        cols: 1
        spacing: dp(3)

        
# =========================================================================================

<EventBox>:
    size_hint_x: 1
    size_hint_y: None
    height: '66dp'
    name: 'temp'
    date: None
    file_location: None
    background_normal: ''
    background_normal: ''
    background_color: CLEAR
    background_down: ''
    border: CLEAR
    canvas.before:
        Color:
            rgba: self.is_selected and TANGY or DIM_TANGY
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(8),]
    Label:
        text: 'Name:  ' + str(root.experiment.name)
        font_name: 'resources\\Inter.ttf'
        font_size: '14dp'
        color: WHITE
        size_hint: (None, None)
        size: (root.width - dp(35), '20dp')
        pos: (root.x + dp(3), root.y + dp(48))
        halign: 'left'
        color: DARK_GREY
        text_size: self.size
        shorten: True
    Label:
        text: 'File:  ' + str(root.experiment.vid_loc).split('\\')[-1].split('/')[-1]
        font_name: 'resources\\Inter.ttf'
        font_size: '14dp'
        color: WHITE
        size_hint: (None, None)
        size: (root.width, '24dp')
        pos: (root.x + dp(3), root.y + dp(27))
        halign: 'left'
        color: DARK_GREY
        text_size: self.size
        shorten: True
    Label:
        text: 'Date:  ' + str(root.experiment.vid_date)
        font_name: 'resources\\Inter.ttf'
        font_size: '14dp'
        color: WHITE
        size_hint: (None, None)
        size: (root.width, '20dp')
        pos: (root.x + dp(3), root.y + dp(7))
        halign: 'left'
        color: DARK_GREY
        text_size: self.size
        shorten: True
    Button:
        text: '×'
        font_name: 'resources\\Inter.ttf'
        font_size: '18dp'
        background_color: CLEAR
        background_normal: ''
        color: DARK_GREY
        size_hint: (None, None)
        size: ('20dp', '20dp')
        pos: (root.x + root.width - dp(20), root.y + root.height - dp(18))
        on_press: root.parent.parent.on_x_btn(root, root.window.name)
    Button:
        background_color: CLEAR
        size_hint: (None, None)
        size: ('13dp', '20dp')
        pos: (root.x + root.width - dp(32), root.y + root.height - dp(19))
        on_press: root.on_open_btn()
        Image:
            source: 'resources\\open_btn.png'
            y: self.parent.y + dp(3)
            x: self.parent.x
            size: ('13dp', '13dp')




# =========================================================================================


<IonCurrentView>:
    y_axis_layout: y_axis_layout
    size_hint: 1, 1
    color: WHITE if self.texture is None else WHITE
    on_touch_down: root._on_touch_down(args[1])
    on_touch_move: root._on_touch_down(args[1])
    FloatLayout:
        id: y_axis_layout
        y: root.y
        x: 0 if root.app.current_experiment != None and root.app.current_has_ion else 69420
        width: root.x
        height: root.height



# =========================================================================================




<ThumbnailBar>:
    orientation: 'horizontal'
    spacing: 1
    on_touch_down: root._on_touch_down(args[1])




# =========================================================================================




<Thumbnail>:
    size_hint: (1 / root.thumbnail_bar.num_thumbnails, 1)
    fit_mode: 'cover'
    on_touch_down: root.set_as_frame(args[1].pos) if args[1].button == 'left' else None
    


# =========================================================================================
<LoadingScreen@FloatLayout>:
    size_hint: (1, 1)
    pos_hint: {'center_y': 0.5}
    canvas.before:
        Color:
            rgba: CLEAR_GREY
        Rectangle:
            pos: self.pos
            size: self.size
    Label:
        pos_hint: {'center_x': 0.5, 'center_y': 0.5}
        size_hint: (0.2, 0.2)
        text: 'Loading...'
        font_size: '25dp'
        font_name: 'resources\\Inter.ttf'
